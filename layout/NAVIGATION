<?php
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

require_once __DIR__ . '/../db.php';            // if not yet included
require_once __DIR__ . '/../rbac.php';          // loads permissions from DB
require_once __DIR__ . '/../permissions.php';   // canView(), canAdd(), etc.

if (!isset($_SESSION['user']) || !is_array($_SESSION['user'])) {
    header("Location: LOGIN.php");
    exit;
}

$user = $_SESSION['user'];

// âœ… Check if user is an approver
$is_hr_approver = false;

if (isset($_SESSION['user_id'])) {
    $uid = (int) $_SESSION['user_id'];

    $stmt = $conn->prepare("
        SELECT 1
        FROM hr_approver_assignments
        WHERE user_id = ?
        LIMIT 1
    ");
    $stmt->bind_param("i", $uid);
    $stmt->execute();
    $stmt->store_result();

    if ($stmt->num_rows > 0) {
        $is_hr_approver = true;
    }
}

ob_start(); // Add this here to buffer any accidental early output

// âœ… Get current page
$current_page = basename($_SERVER['PHP_SELF']);

// âœ… Define collapsible groups
$app_pages = [
    'LEAVE_APPLICATION.PHP', 'OVERTIME.PHP', 'OFFICIAL_BUSINESS.PHP',
    'CHANGE_SCHEDULE.PHP', 'FAILURE_CLOCK.PHP', 'CLOCK_ALTERATION.PHP',
    'WORK_RESTDAY.PHP'
];
$app_active = in_array($current_page, $app_pages);

$approving_pages = [
    'PENDING_LEAVES.PHP', 'APPROVER_OVERTIME.PHP', 'APPROVER_OFFICIAL_BUSINESS.PHP',
    'APPROVER_CHANGE_SCHEDULE.PHP', 'APPROVER_FAILURE_CLOCK.PHP',
    'APPROVER_CLOCK_ALTERATION.PHP', 'APPROVER_WORK_RESTDAY.PHP'
];
$approving_active = in_array($current_page, $approving_pages);

$reports_pages = ['TIMECARD.PHP', 'TARDINESS_REPORT.PHP', 'LEAVE_CREDIT_MONITORING_1.PHP', 'LEAVE_TRANSACTION.PHP', 'VIEW_LOGS.PHP'];
$reports_active = in_array($current_page, $reports_pages);

$hr_pages = [
    'HR_APPROVER_MAINTENANCE.PHP',
    'GENERATE_ID-TEST.PHP',
    'GENERATE_COE-TEST.PHP',
    'LOG_HISTORY-MULTIPLE_USER.PHP',
    'HR_TARDINESS_REPORT.PHP',
    'SSS_CONTRIBUTION.PHP',
    'PAG-IBIG_CONTRIBUTION.PHP',
    'APPROVER_201_FILE.PHP'
];
$hr_active = in_array($current_page, $hr_pages);


$hr_approving_pages = [
    'HR_LEAVE_APPROVAL.PHP', 'HR_OVERTIME_APPROVAL.PHP', 'HR_OFFICIAL_BUSINESS_APPROVAL.PHP',
    'HR_CHANGE_SCHEDULE_APPROVAL.PHP', 'HR_FAILURE_CLOCK_APPROVAL.PHP',
    'HR_CLOCK_ALTERATION_APPROVAL.PHP', 'HR_WORK_RESTDAY_APPROVAL.PHP'
];
$hr_approving_active = in_array($current_page, $hr_approving_pages);
?>

<style>
/* ðŸ”¹ Active page highlight */
.nav-link.active {
    background-color: #0d6efd !important;
    color: #fff !important;
    font-weight: bold;
    border-radius: 6px;
}

/* ðŸ”¹ Icon color when active */
.nav-link.active .sb-nav-link-icon i {
    color: #fff !important;
}

/* ðŸ”¹ Highlight parent menu if one of its children is active */
.nav-link[data-bs-toggle="collapse"].active-parent {
    background-color: rgba(13, 110, 253, 0.2);
    color: #fff;
    font-weight: bold;
}

.nav-link.active-parent {
    background-color: rgba(13, 110, 253, 0.25) !important;
    color: #fff !important;
    font-weight: bold;
}
</style>

<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
                <div class="nav">

                    <?php if (canView('dashboard')): ?>
                    <a class="nav-link <?= ($current_page == 'INDEX.php') ? 'active' : '' ?>" href="INDEX.php">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Dashboard
                    </a>
                    <?php endif; ?>

                    <?php if (canView('profile')): ?>
                    <a class="nav-link <?= ($current_page == 'VIEW_PROFILE.php') ? 'active' : '' ?>" href="VIEW_PROFILE.php">
                        <div class="sb-nav-link-icon"><i class="fas fa-id-card me-1"></i></div>
                        Profile
                    </a>
                    <?php endif; ?>

                    <!-- ======================= APPLICATIONS ======================= -->
                    <a class="nav-link <?= $app_active ? 'active-parent' : 'collapsed' ?>"
                       href="#" data-bs-toggle="collapse"
                       data-bs-target="#collapseApplication"
                       aria-expanded="<?= $app_active ? 'true' : 'false' ?>">
                        <div class="sb-nav-link-icon"><i class="fas fa-file"></i></div>
                        Application
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>

                    <div class="collapse <?= $app_active ? 'show' : '' ?>" id="collapseApplication" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link <?= ($current_page == 'LEAVE_APPLICATION.PHP') ? 'active' : '' ?>" href="LEAVE_APPLICATION.PHP">Leave Application</a>
                            <a class="nav-link <?= ($current_page == 'OVERTIME.PHP') ? 'active' : '' ?>" href="OVERTIME.PHP">Overtime</a>
                            <a class="nav-link <?= ($current_page == 'OFFICIAL_BUSINESS.PHP') ? 'active' : '' ?>" href="OFFICIAL_BUSINESS.PHP">Official Business</a>
                            <a class="nav-link <?= ($current_page == 'CHANGE_SCHEDULE.PHP') ? 'active' : '' ?>" href="CHANGE_SCHEDULE.PHP">Change Schedule</a>
                            <a class="nav-link <?= ($current_page == 'FAILURE_CLOCK.PHP') ? 'active' : '' ?>" href="FAILURE_CLOCK.PHP">Failure to Clock In/Out</a>
                            <a class="nav-link <?= ($current_page == 'CLOCK_ALTERATION.PHP') ? 'active' : '' ?>" href="CLOCK_ALTERATION.PHP">Clock Alteration</a>
                            <a class="nav-link <?= ($current_page == 'WORK_RESTDAY.PHP') ? 'active' : '' ?>" href="WORK_RESTDAY.PHP">Work On Restday</a>
                        </nav>
                    </div>

                    <!-- ======================= APPROVING (IF APPROVER) ======================= -->
                    <?php if ($approver): ?>
                        <a class="nav-link <?= $approving_active ? 'active-parent' : 'collapsed' ?>"
                           href="#" data-bs-toggle="collapse"
                           data-bs-target="#collapseApproving"
                           aria-expanded="<?= $approving_active ? 'true' : 'false' ?>">
                            <div class="sb-nav-link-icon"><i class="fas fa-check-circle"></i></div>
                            Approving
                            <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                        </a>

                        <div class="collapse <?= $approving_active ? 'show' : '' ?>" id="collapseApproving" data-bs-parent="#sidenavAccordion">
                            <nav class="sb-sidenav-menu-nested nav">
                                <a class="nav-link <?= ($current_page == 'PENDING_LEAVES.PHP') ? 'active' : '' ?>" href="PENDING_LEAVES.PHP">Leave Application</a>
                                <a class="nav-link <?= ($current_page == 'APPROVER_OVERTIME.PHP') ? 'active' : '' ?>" href="APPROVER_OVERTIME.PHP">Overtime</a>
                                <a class="nav-link <?= ($current_page == 'APPROVER_OFFICIAL_BUSINESS.PHP') ? 'active' : '' ?>" href="APPROVER_OFFICIAL_BUSINESS.PHP">Official Business</a>
                                <a class="nav-link <?= ($current_page == 'APPROVER_CHANGE_SCHEDULE.PHP') ? 'active' : '' ?>" href="APPROVER_CHANGE_SCHEDULE.PHP">Change Schedule</a>
                                <a class="nav-link <?= ($current_page == 'APPROVER_FAILURE_CLOCK.PHP') ? 'active' : '' ?>" href="APPROVER_FAILURE_CLOCK.PHP">Failure to Clock</a>
                                <a class="nav-link <?= ($current_page == 'APPROVER_CLOCK_ALTERATION.PHP') ? 'active' : '' ?>" href="APPROVER_CLOCK_ALTERATION.PHP">Clock Alteration</a>
                                <a class="nav-link <?= ($current_page == 'APPROVER_WORK_RESTDAY.PHP') ? 'active' : '' ?>" href="APPROVER_WORK_RESTDAY.PHP">Work Restday</a>
                            </nav>
                        </div>
                    <?php endif; ?>

                    <!-- ======================= OTHER MENUS ======================= -->
                    <?php if (canView('user_maintenance')): ?>
                        <a class="nav-link <?= ($current_page == 'USER_MAINTENANCE.php') ? 'active' : '' ?>" href="USER_MAINTENANCE.php">
                            <div class="sb-nav-link-icon"><i class="fas fa-users"></i></div>Users Info
                        </a>
                    <?php endif; ?>

                    <?php if (canView('directory')): ?>
                        <a class="nav-link <?= ($current_page == 'DIRECTORY.php') ? 'active' : '' ?>" href="DIRECTORY.php">
                            <div class="sb-nav-link-icon"><i class="fas fa-building"></i></div>Directory
                        </a>
                    <?php endif; ?>

                    <?php if (canView('contact_details')): ?>
                        <a class="nav-link <?= ($current_page == 'CONTACT_DETAILS.php') ? 'active' : '' ?>" href="CONTACT_DETAILS.php">
                            <div class="sb-nav-link-icon"><i class="fas fa-phone"></i></div>Contact Details
                        </a>
                    <?php endif; ?>

                    <?php if (canView('calendar')): ?>
                        <a class="nav-link <?= ($current_page == 'CALENDAR.php') ? 'active' : '' ?>" href="CALENDAR.php">
                            <div class="sb-nav-link-icon"><i class="fas fa-calendar"></i></div>Calendar
                        </a>
                    <?php endif; ?>
                    
                    <?php if (canView('log_history')): ?>
                        <a class="nav-link <?= ($current_page == 'LOG_HISTORY.php') ? 'active' : '' ?>" href="LOG_HISTORY.php">
                            <div class="sb-nav-link-icon"><i class="fas fa-clipboard-list"></i></div>Log History
                        </a>
                    <?php endif; ?>

                    <?php if (canView('maintenance')): ?>
                        <a class="nav-link <?= ($current_page == 'MAINTENANCE.php') ? 'active' : '' ?>" href="MAINTENANCE.php">
                            <div class="sb-nav-link-icon"><i class="fas fa-tools"></i></div>Maintenance
                        </a>
                    <?php endif; ?>

                    <!-- ======================= REPORTS ======================= -->
                    <?php if (canView('reports')): ?>
                        <a class="nav-link <?= $reports_active ? 'active-parent' : 'collapsed' ?>"
                        href="#" data-bs-toggle="collapse"
                        data-bs-target="#collapseReports"
                        aria-expanded="<?= $reports_active ? 'true' : 'false' ?>">
                            <div class="sb-nav-link-icon"><i class="fas fa-chart-bar"></i></div>
                            Reports
                            <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                        </a>
                    <?php endif; ?> 

                    <div class="collapse <?= $reports_active ? 'show' : '' ?>" id="collapseReports" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link <?= ($current_page == 'TIMECARD.PHP') ? 'active' : '' ?>" href="TIMECARD.PHP">Timecard</a>
                            <a class="nav-link <?= ($current_page == 'TARDINESS_REPORT.PHP') ? 'active' : '' ?>" href="TARDINESS_REPORT.PHP">Tardiness</a>
                            <a class="nav-link <?= ($current_page == 'LEAVE_CREDIT_MONITORING_1.PHP') ? 'active' : '' ?>" href="LEAVE_CREDIT_MONITORING_1.PHP">Leave Credit Monitoring</a>
                            <a class="nav-link <?= ($current_page == 'LEAVE_TRANSACTION.PHP') ? 'active' : '' ?>" href="LEAVE_TRANSACTION.PHP">Leave Transaction</a>
                            <?php if (canView('view_logs')): ?>
                                <a class="nav-link <?= ($current_page == 'VIEW_LOGS.PHP') ? 'active' : '' ?>" href="VIEW_LOGS.PHP">Audit Trail</a>
                            <?php endif; ?>
                        </nav>
                    </div>

                    <!-- ======================= ANNOUNCEMENT ======================= -->
                    <?php if (canView('announcements')): ?>
                        <a class="nav-link <?= ($current_page == 'ANNOUNCEMENTS.php') ? 'active' : '' ?>" href="ANNOUNCEMENTS.php">
                            <div class="sb-nav-link-icon"><i class="fas fa-bullhorn"></i></div>Announcements
                        </a>
                    <?php endif; ?>

                    <!-- ======================= HR MODULES ======================= -->
                    <?php if (canView('hr_modules')): ?>
                        <a class="nav-link <?= $hr_active ? 'active-parent' : 'collapsed' ?>"
                        href="#" data-bs-toggle="collapse"
                        data-bs-target="#collapseHRModules"
                        aria-expanded="<?= $hr_active ? 'true' : 'false' ?>">
                            <div class="sb-nav-link-icon"><i class="fas fa-chart-bar"></i></div>
                            HR Modules
                            <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                        </a>
                    <?php endif; ?>

                    <div class="collapse <?= $hr_active ? 'show' : '' ?>" id="collapseHRModules" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link <?= ($current_page == 'HR_APPROVER_MAINTENANCE.PHP') ? 'active' : '' ?>" href="HR_APPROVER_MAINTENANCE.PHP">Assigned HR Approvers</a>
                            <a class="nav-link <?= ($current_page == 'GENERATE_ID-TEST.PHP') ? 'active' : '' ?>" href="GENERATE_ID-TEST.PHP">Generation of ID</a>
                            <a class="nav-link <?= ($current_page == 'GENERATE_COE-TEST.PHP') ? 'active' : '' ?>" href="GENERATE_COE-TEST.PHP">Generation of COE</a>
                            <a class="nav-link <?= ($current_page == 'LOG_HISTORY-MULTIPLE_USER.PHP') ? 'active' : '' ?>" href="LOG_HISTORY-MULTIPLE_USER.PHP">Log History(Multiple Users)</a>
                            <a class="nav-link <?= ($current_page == 'HR_TARDINESS_REPORT.PHP') ? 'active' : '' ?>" href="HR_TARDINESS_REPORT.PHP">Tardiness Report (Multiple Employees)</a>
                            <a class="nav-link <?= ($current_page == 'SSS_CONTRIBUTION.PHP') ? 'active' : '' ?>" href="SSS_CONTRIBUTION.PHP">Benefits Maintenance (SSS)</a>
                            <a class="nav-link <?= ($current_page == 'PAG-IBIG_CONTRIBUTION.PHP') ? 'active' : '' ?>" href="PAG-IBIG_CONTRIBUTION.PHP">Benefits Maintenance (PAG-IBIG)</a>
                            <a class="nav-link <?= ($current_page == 'PHILHEALTH_CONTRIBUTION.PHP') ? 'active' : '' ?>" href="PHILHEALTH_CONTRIBUTION.PHP">Benefits Maintenance (PhilHealth)</a>
                            <a class="nav-link <?= ($current_page == 'APPROVER_201_FILE.PHP') ? 'active' : '' ?>" href="APPROVER_201_FILE.PHP">Approving Upload Req. (Per Users)</a>
                        </nav>
                    </div>

                    <!-- ======================= HR APPROVING ======================= -->
                    <?php if ($is_hr_approver): ?>
                        <a class="nav-link <?= $hr_approving_active ? 'active-parent' : 'collapsed' ?>"
                            href="#" data-bs-toggle="collapse"
                            data-bs-target="#collapse_HR_Approving"
                            aria-expanded="<?= $hr_approving_active ? 'true' : 'false' ?>">
                            <div class="sb-nav-link-icon"><i class="fas fa-check-circle"></i></div>
                            HR Approving
                            <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                        </a>

                        <div class="collapse <?= $hr_approving_active ? 'show' : '' ?>" id="collapse_HR_Approving" data-bs-parent="#sidenavAccordion">
                            <nav class="sb-sidenav-menu-nested nav">
                                <a class="nav-link <?= ($current_page == 'HR_LEAVE_APPROVAL.PHP') ? 'active' : '' ?>" href="HR_LEAVE_APPROVAL.PHP">Leave Application</a>
                                <a class="nav-link <?= ($current_page == 'HR_OVERTIME_APPROVAL.PHP') ? 'active' : '' ?>" href="HR_OVERTIME_APPROVAL.PHP">Overtime</a>
                                <a class="nav-link <?= ($current_page == 'HR_OFFICIAL_BUSINESS_APPROVAL.PHP') ? 'active' : '' ?>" href="HR_OFFICIAL_BUSINESS_APPROVAL.PHP">Official Business</a>
                                <a class="nav-link <?= ($current_page == 'HR_CHANGE_SCHEDULE_APPROVAL.PHP') ? 'active' : '' ?>" href="HR_CHANGE_SCHEDULE_APPROVAL.PHP">Change Schedule</a>
                                <a class="nav-link <?= ($current_page == 'HR_FAILURE_CLOCK_APPROVAL.PHP') ? 'active' : '' ?>" href="HR_FAILURE_CLOCK_APPROVAL.PHP">Failure to Clock</a>
                                <a class="nav-link <?= ($current_page == 'HR_CLOCK_ALTERATION_APPROVAL.PHP') ? 'active' : '' ?>" href="HR_CLOCK_ALTERATION_APPROVAL.PHP">Clock Alteration</a>
                                <a class="nav-link <?= ($current_page == 'HR_WORK_RESTDAY_APPROVAL.PHP') ? 'active' : '' ?>" href="HR_WORK_RESTDAY_APPROVAL.PHP">Work Restday</a>
                            </nav>
                        </div>
                    <?php endif; ?>
                    
                    <!-- ======================= SYSTEM SETTING ======================= -->
                    <?php if (canView('system_settings')): ?>
                        <a class="nav-link <?= ($current_page == 'SETTINGS.php') ? 'active' : '' ?>" href="SETTINGS.php">
                            <div class="sb-nav-link-icon"><i class="fas fa-cog"></i></div>System Settings
                        </a>
                    <?php endif; ?>
                </div>
            </div>
            
            <div class="sb-sidenav-footer">
                <div class="small">Logged in as:</div>
                <?= htmlspecialchars($user['username']); ?>
            </div>
        </nav>
    </div>


